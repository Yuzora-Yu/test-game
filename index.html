<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚¬ãƒãƒ£æ¼”å‡ºãƒ»ã‚«ãƒ¼ãƒ‰ã‚ãã‚Šãƒ‡ãƒ¢</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
  :root{
    --w: min(1100px, 96vw);
    --bg: radial-gradient(1200px 600px at 50% -100px, #1d2332 0%, #0c0f1a 45%, #070915 100%);
  }
  html,body{height:100%}
  body{margin:0;color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI","Hiragino Sans","Noto Sans JP",Roboto,"Yu Gothic UI",sans-serif;background:var(--bg)}

  header,main,footer{width:var(--w);margin:18px auto}
  header h1{margin:8px 0 4px;font-size:clamp(22px,3.6vw,28px)}
  header p{margin:0;color:#b9c4d4}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{padding:10px 14px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.06);color:#fff;border-radius:8px;cursor:pointer;backdrop-filter:blur(4px)}
  .btn.primary{background:linear-gradient(135deg,#ff357a,#ff8a00);border-color:transparent}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  /* ã‚¹ãƒ†ãƒ¼ã‚¸ */
  #stage{position:relative;height:260px;border-radius:14px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));box-shadow:0 12px 40px rgba(0,0,0,.35) inset,0 8px 26px rgba(0,0,0,.24)}
  .flash{position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,rgba(255,255,255,.9),transparent 60%);opacity:0;pointer-events:none;transition:opacity 200ms ease}
  .flash.show{opacity:1}
  #shakeHost.shake{animation:shake .6s cubic-bezier(.36,.07,.19,.97) both}
  @keyframes shake{10%,90%{transform:translate3d(-1px,0,0)}20%,80%{transform:translate3d(2px,0,0)}30%,50%,70%{transform:translate3d(-4px,0,0)}40%,60%{transform:translate3d(4px,0,0)}}

  /* çµæœã‚«ãƒ¼ãƒ‰ */
  #card{margin-top:16px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.26)}
  .summary{display:flex;align-items:center;gap:10px}
  .badge{background:#e0133c;padding:4px 10px;border-radius:999px;font-weight:700}
  .rightbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

  /* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:12px}
  @media (max-width:640px){.grid{grid-template-columns:repeat(3,1fr)}}

  /* ã‚«ãƒ¼ãƒ‰ï¼ˆ3Dã‚ãã‚Šï¼‰ */
  .card{perspective:900px}
  .card .inner{position:relative;height:140px;border-radius:12px;transform-style:preserve-3d;transition:transform 700ms cubic-bezier(.2,.8,.2,1)}
  .card.open .inner{transform:rotateY(180deg)}
  .face{position:absolute;inset:0;border-radius:12px;backface-visibility:hidden;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
  .back{background:linear-gradient(135deg,#1a2030,#0e1422);display:grid;place-items:center}
  .back::after{content:"â˜…";font-size:28px;color:#8fb1ff;opacity:.8}

  .front{transform:rotateY(180deg);background:#0b0f1b;display:grid;grid-template-rows:1fr auto;place-items:center}
  .art{width:100%;height:100%;display:grid;place-items:center;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01))}
  .art img{max-width:100%;max-height:100%;object-fit:contain}
  .icon{font-size:30px}
  .name{width:100%;text-align:center;font-size:12px;color:#d5dfef;padding:6px 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background:rgba(255,255,255,.04);border-top:1px solid rgba(255,255,255,.06)}
  .glow{position:absolute;inset:-2px;border-radius:12px;pointer-events:none;mix-blend-mode:screen;opacity:.8}

  /* ãƒ¬ã‚¢åº¦è‰² */
  .R .glow{background:radial-gradient(80% 60% at 50% -10%,rgba(86,204,242,.35),transparent 60%)}
  .SR .glow{background:radial-gradient(80% 60% at 50% -10%,rgba(193,168,255,.40),transparent 60%)}
  .SSR .glow{background:radial-gradient(80% 60% at 50% -10%,rgba(255,216,112,.45),transparent 60%)}
  .UR .glow{background:radial-gradient(80% 60% at 50% -10%,rgba(0,227,174,.50),transparent 60%)}

  /* ç´™å¹é›ªã‚­ãƒ£ãƒ³ãƒã‚¹ */
  #confetti{position:fixed;inset:0;pointer-events:none}
</style>

<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body id="shakeHost">
<header>
  <h1>ã‚¬ãƒãƒ£æ¼”å‡ºï¼ˆã‚«ãƒ¼ãƒ‰ã‚ãã‚Šï¼‰</h1>
  <p>å˜ç™º/10é€£ã€‚ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ã‚ãã‚Šã€‚SSR/URã¯éæ¿€æ¼”å‡ºã€‚çµæœã‚’ç”»åƒä¿å­˜ï¼†Tweetã€‚</p>
  <div class="toolbar">
    <button class="btn" id="btnSingle">å˜ç™ºï¼ˆ1å›ï¼‰</button>
    <button class="btn primary" id="btnTen">10é€£</button>
    <button class="btn" id="btnFlipAll" disabled>å…¨éƒ¨ã‚ãã‚‹</button>
    <button class="btn" id="btnReset">ã‚¯ãƒªã‚¢</button>
  </div>
</header>

<main style="width:var(--w);margin:auto">
  <div id="stage">
    <div class="flash" id="flash"></div>
    <canvas id="confetti"></canvas>
  </div>

  <!-- çµæœï¼ˆä¿å­˜å¯¾è±¡ï¼‰ -->
  <section id="card">
    <div class="summary">
      <span class="badge" id="badge">0 å›</span>
      <div id="headline">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    <div class="grid" id="grid"></div>

    <div class="rightbar">
      <button class="btn" id="btnSave">çµæœã‚’ç”»åƒä¿å­˜</button>
      <button class="btn" id="btnTweet">Tweetï¼ˆçµæœã‚’å…±æœ‰ï¼‰</button>
    </div>
    <p style="color:#9fb1c8;font-size:12px;margin:6px 0 0;">â€»ç”»åƒã¯è‡ªå‹•æ·»ä»˜ã§ããªã„ãŸã‚ã€ä¿å­˜å¾Œã«ãƒ„ã‚¤ãƒ¼ãƒˆç”»é¢ã§æ·»ä»˜ã—ã¦ãã ã•ã„ã€‚</p>
  </section>
</main>

<footer style="width:var(--w);margin:20px auto;color:#9fb1c8;font-size:12px">
  <p>ç”»åƒã¯ <code>POOL</code> ã® <code>img</code> ã«ãƒ‘ã‚¹/URLã‚’å…¥ã‚Œã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆæœªæŒ‡å®šæ™‚ã¯çµµæ–‡å­—ï¼‰ã€‚</p>
</footer>

<script>
/* ---------------- è¨­å®š ---------------- */
const RARITY = {
  "R":   { rate: 0.75 },
  "SR":  { rate: 0.20 },
  "SSR": { rate: 0.045 },
  "UR":  { rate: 0.005 }
};
/* ç”»åƒã‚ã‚Š/ãªã—æ··åœ¨OKï¼ˆimgæœªæŒ‡å®šã¯çµµæ–‡å­—iconã‚’ä½¿ã†ï¼‰ */
const POOL = [
  { name:"ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚½ãƒ¼ãƒ‰", rarity:"R",   weight: 10, icon:"ğŸ—¡ï¸", img:"" },
  { name:"ãƒ’ãƒ¼ãƒ«ãƒãƒ¼ã‚·ãƒ§ãƒ³", rarity:"R",   weight: 10, icon:"ğŸ§ª", img:"" },
  { name:"ãƒ©ã‚¤ãƒˆãƒœã‚¦",       rarity:"R",   weight: 10, icon:"ğŸ¹", img:"" },
  { name:"é­”è¡“æ›¸ã®åˆ‡ã‚Œç«¯",   rarity:"R",   weight: 10, icon:"ğŸ“œ", img:"" },
  { name:"é›·é³´ã®æŒ‡è¼ª",       rarity:"SR",  weight: 7,  icon:"ğŸ’", img:"assets/ring.png" },   /* ä¾‹ï¼šassets é…ä¸‹ã«ç½®ã */
  { name:"ç´…è“®ã®ãƒ­ãƒ¼ãƒ–",     rarity:"SR",  weight: 7,  icon:"ğŸ§¥", img:"" },
  { name:"è’¼ãå®ç ",         rarity:"SR",  weight: 6,  icon:"ğŸ”®", img:"" },
  { name:"å¤©ç©ºã®å¤§å‰£",       rarity:"SSR", weight: 3,  icon:"âš”ï¸", img:"assets/sword.png" },
  { name:"é³³å‡°ã®ç¿¼",         rarity:"SSR", weight: 2,  icon:"ğŸª½", img:"" },
  { name:"ä¸–ç•Œæ¨¹ã®æ",       rarity:"UR",  weight: 1,  icon:"ğŸŒ¿", img:"assets/branch.png" },
];
const GUARANTEE_MIN_RARITY = "SR";

/* ---------------- ä¾¿åˆ©é–¢æ•° ---------------- */
const sum = a => a.reduce((x,y)=>x+y,0);
const pickWeighted = (arr,key="weight")=>{
  const total = sum(arr.map(e=>e[key]??1)); let r=Math.random()*total;
  for(const e of arr){ r -= (e[key]??1); if(r<0) return e; }
  return arr.at(-1);
};
const now = () => new Date().toLocaleString("ja-JP");
const rankIndex = r => ({R:0,SR:1,SSR:2,UR:3}[r]??0);

/* ---------------- æŠ½é¸ ---------------- */
function drawOne(){
  const r = pickWeighted(Object.entries(RARITY).map(([k,v])=>({key:k,weight:v.rate})),"weight").key;
  const cand = POOL.filter(p=>p.rarity===r);
  return pickWeighted(cand);
}
function drawTen(){
  const res = Array.from({length:10},()=>drawOne());
  if(!res.some(x=>rankIndex(x.rarity)>=rankIndex(GUARANTEE_MIN_RARITY))){
    const cand = POOL.filter(x=>rankIndex(x.rarity)>=rankIndex(GUARANTEE_MIN_RARITY));
    res[res.length-1] = pickWeighted(cand);
  }
  return res;
}

/* ---------------- ç”»é¢è¦ç´  ---------------- */
const grid = document.getElementById("grid");
const badge = document.getElementById("badge");
const headline = document.getElementById("headline");
const btnFlipAll = document.getElementById("btnFlipAll");
const flash = document.getElementById("flash");
const shakeHost = document.getElementById("shakeHost");

/* ---------------- ã‚«ãƒ¼ãƒ‰æç”» ---------------- */
let currentItems = [];
let openedCount = 0;

function renderBacks(n){
  grid.innerHTML = "";
  for(let i=0;i<n;i++){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="inner">
        <div class="face back"></div>
        <div class="face front"><div class="glow"></div>
          <div class="art"></div>
          <div class="name"></div>
        </div>
      </div>`;
    grid.appendChild(card);
  }
  openedCount = 0;
  btnFlipAll.disabled = false;
}

function setCardData(card, item){
  const front = card.querySelector(".front");
  const art = card.querySelector(".art");
  const name = card.querySelector(".name");
  front.classList.add(item.rarity);

  if(item.img){
    const img = new Image();
    img.alt = item.name;
    img.src = item.img;
    art.innerHTML = ""; art.appendChild(img);
  }else{
    art.innerHTML = `<div class="icon">${item.icon||"ğŸ´"}</div>`;
  }
  name.textContent = item.name;

  // ã‚¯ãƒªãƒƒã‚¯ã§ã‚ãã‚‹
  card.addEventListener("click", ()=>{
    if(card.classList.contains("open")) return;
    card.classList.add("open");
    openedCount++;
    if(item.rarity==="SSR" || item.rarity==="UR") boomEffect(item.rarity);
    if(openedCount>=currentItems.length) btnFlipAll.disabled = true;
  }, {once:false});
}

function showResults(items){
  currentItems = items.slice();
  renderBacks(items.length);

  // å„ã‚«ãƒ¼ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿åæ˜ ï¼ˆè£é¢ã®ã¾ã¾ï¼‰
  Array.from(grid.children).forEach((card,i)=> setCardData(card, items[i]));

  badge.textContent = `${items.length} å›`;
  const c = countByRarity(items);
  headline.textContent = `${now()}ï½œUR:${c.UR} / SSR:${c.SSR} / SR:${c.SR} / R:${c.R}`;
}

/* ---------------- æ¼”å‡ºï¼šSSR/URã§éæ¿€ ---------------- */
function boomEffect(rarity){
  // 1) ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
  flash.classList.add("show");
  setTimeout(()=>flash.classList.remove("show"), 140);

  // 2) ã‚·ã‚§ã‚¤ã‚¯ï¼ˆå¼·åº¦ã¯ãƒ¬ã‚¢åº¦ã§å¤‰ãˆã‚‹ï¼‰
  shakeHost.classList.add("shake");
  setTimeout(()=>shakeHost.classList.remove("shake"), 620);

  // 3) ç´™å¹é›ª
  confettiBurst(rarity);
}

/* ------- ç´™å¹é›ªï¼ˆç°¡æ˜“ï¼‰ ------- */
const cvs = document.getElementById("confetti");
const ctx = cvs.getContext("2d");
let pieces = [];
function resize(){ cvs.width = innerWidth; cvs.height = innerHeight; }
addEventListener("resize", resize); resize();
function confettiColor(r){
  return r==="UR" ? ["#00e3ae","#78ffd6","#e0fff4"] :
         r==="SSR"? ["#ffd76f","#ffae00","#ffe9a3"] :
                    ["#c8a7ff","#e6d6ff","#a98aff"];
}
function confettiBurst(rarity){
  const colors = confettiColor(rarity);
  const N = rarity==="UR" ? 220 : 150;
  for(let i=0;i<N;i++){
    pieces.push({
      x: innerWidth/2, y: innerHeight*0.38,
      vx: (Math.random()*2-1)* (6 + Math.random()*4),
      vy: - (6 + Math.random()*3),
      g:  0.18 + Math.random()*0.05,
      w:  3 + Math.random()*3,
      h:  6 + Math.random()*6,
      c:  colors[i%colors.length],
      a:  1,
      r:  Math.random()*Math.PI
    });
  }
}
function tick(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  for(const p of pieces){
    p.x += p.vx; p.y += p.vy; p.vy += p.g; p.r += 0.1; p.a -= 0.007;
    ctx.save(); ctx.globalAlpha = Math.max(p.a,0);
    ctx.translate(p.x,p.y); ctx.rotate(p.r);
    ctx.fillStyle = p.c; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
    ctx.restore();
  }
  pieces = pieces.filter(p=>p.a>0 && p.y < innerHeight+40);
  requestAnimationFrame(tick);
}
tick();

/* ---------------- é›†è¨ˆ/ä¿å­˜/Tweet ---------------- */
function countByRarity(items){
  const c={R:0,SR:0,SSR:0,UR:0}; for(const it of items) c[it.rarity]++; return c;
}
document.getElementById("btnSave").addEventListener("click", async ()=>{
  const target = document.getElementById("card");
  const canvas = await html2canvas(target,{scale:2,backgroundColor:"#0c0f1a"});
  const a = document.createElement("a");
  a.download = `gacha_result_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
  a.href = canvas.toDataURL("image/png"); a.click();
});
document.getElementById("btnTweet").addEventListener("click", ()=>{
  const text = encodeURIComponent(headline.textContent + " #ã‚¬ãƒãƒ£ #ã‚«ãƒ¼ãƒ‰ã‚ãã‚Š");
  const url  = encodeURIComponent(location.href);
  window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`,"_blank");
});

/* ---------------- ãƒœã‚¿ãƒ³ ---------------- */
document.getElementById("btnSingle").addEventListener("click", ()=>{
  showResults([drawOne()]);
});
document.getElementById("btnTen").addEventListener("click", ()=>{
  showResults(drawTen());
});
document.getElementById("btnReset").addEventListener("click", ()=>{
  grid.innerHTML = ""; badge.textContent = "0 å›"; headline.textContent = "çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™";
  pieces.length = 0; // ç´™å¹é›ªã‚¯ãƒªã‚¢
});
document.getElementById("btnFlipAll").addEventListener("click", ()=>{
  Array.from(grid.children).forEach(c=>c.classList.add("open"));
  btnFlipAll.disabled = true;
});
</script>
</body>
</html>
