<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ソシャゲ風ガチャ演出デモ</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
  :root{
    --w: min(1100px, 96vw);
    --bg: radial-gradient(1200px 600px at 50% -100px, #293245 0%, #0e1220 45%, #080a14 100%);
    --acc: #00d4ff;
  }
  html,body{height:100%;}
  body{
    margin:0; color:#fff; font-family: ui-sans-serif, system-ui, -apple-system,
    "Segoe UI","Hiragino Sans","Noto Sans JP", Roboto, "Yu Gothic UI", sans-serif;
    background: var(--bg);
  }
  header, main, footer{ width: var(--w); margin: 18px auto; }
  header h1{ margin: 8px 0 4px; font-size: clamp(22px,3.6vw,28px); letter-spacing:.03em;}
  header p{ margin: 0; color:#b9c4d4; }
  .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  .btn{
    padding:10px 14px; border:1px solid rgba(255,255,255,.25);
    background: rgba(255,255,255,.06); color:#fff; border-radius:8px; cursor:pointer;
    backdrop-filter: blur(4px);
  }
  .btn.primary{ background: linear-gradient(135deg,#ff357a,#ff8a00); border-color: transparent; }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }

  /* 演出 */
  #stage{ position:relative; height: 260px; border-radius:14px; overflow:hidden;
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    box-shadow: 0 12px 40px rgba(0,0,0,.35) inset, 0 8px 26px rgba(0,0,0,.24);
  }
  .doors, .flare, .particles{ position:absolute; inset:0; }
  .doors{
    display:grid; grid-template-columns: 1fr 1fr;
  }
  .door{
    background: linear-gradient(180deg,#202738,#111623);
    border-right: 1px solid rgba(255,255,255,.06);
    box-shadow: inset 0 0 60px rgba(0,0,0,.45);
    transform: translateX(0);
    transition: transform 900ms cubic-bezier(.2,.8,.2,1);
  }
  .door.right{ border-right: none; border-left: 1px solid rgba(255,255,255,.06); }
  .doors.open .left  { transform: translateX(-100%); }
  .doors.open .right { transform: translateX( 100%); }

  .flare{ opacity:0; transition: opacity 500ms ease; }
  .flare.show{ opacity:1; background:
      radial-gradient(600px 240px at 50% 50%, rgba(255,255,255,.25), transparent 60%),
      radial-gradient(1000px 400px at 50% 140%, var(--flare, rgba(0,212,255,.15)), transparent 60%);
    mix-blend-mode: screen;
  }

  /* 結果カード */
  #card{ margin-top:16px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    border-radius:14px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.26); }
  .summary{ display:flex; align-items:center; gap:10px; }
  .badge{ background:#e0133c; padding:4px 10px; border-radius:999px; font-weight:700; }
  .grid{ display:grid; grid-template-columns: repeat(5,1fr); gap:10px; margin-top:12px; }
  @media (max-width:640px){ .grid{ grid-template-columns: repeat(3,1fr); } }

  .item{
    background: #0b0f1b; border-radius:10px; padding:10px; text-align:center;
    border:1px solid rgba(255,255,255,.08); position:relative; overflow:hidden;
  }
  .item .icon{ font-size:28px; }
  .item .name{ margin-top:6px; font-size:12px; color:#d5dfef; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .rarity{ position:absolute; inset:auto 0 0 0; height:6px; }
  .R{ background: linear-gradient(90deg,#56ccf2,#2f80ed); }
  .SR{ background: linear-gradient(90deg,#a18cd1,#fbc2eb); }
  .SSR{ background: linear-gradient(90deg,#ffd76f,#ff8a00); }
  .UR{ background: linear-gradient(90deg,#9be15d,#00e3ae); }

  .rightbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
</style>

<!-- 画像保存用 -->
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<header>
  <h1>ガチャ演出デモ</h1>
  <p>単発/10連、最低1枚SR以上保証、結果を画像保存＆Tweet。</p>
  <div class="toolbar">
    <button class="btn" id="btnSingle">単発（1回）</button>
    <button class="btn primary" id="btnTen">10連</button>
    <button class="btn" id="btnReset">クリア</button>
  </div>
</header>

<main style="width:var(--w); margin:auto;">
  <!-- 演出ステージ -->
  <div id="stage" aria-label="演出ステージ">
    <div class="doors" id="doors">
      <div class="door left"></div>
      <div class="door right"></div>
    </div>
    <div class="flare" id="flare"></div>
    <canvas class="particles" id="particles"></canvas>
  </div>

  <!-- 結果カード（保存対象） -->
  <section id="card">
    <div class="summary">
      <span class="badge" id="badge">0 回</span>
      <div id="headline">結果がここに表示されます</div>
    </div>
    <div class="grid" id="grid"></div>

    <div class="rightbar">
      <button class="btn" id="btnSave">結果を画像保存</button>
      <button class="btn" id="btnTweet">Tweet（結果を共有）</button>
    </div>
    <p style="color:#9fb1c8;font-size:12px;margin:6px 0 0;">
      ※画像は自動添付できないため、保存後にツイート画面で添付してください。
    </p>
  </section>
</main>

<footer style="width:var(--w); margin:20px auto; color:#9fb1c8; font-size:12px;">
  <p>デモ用：レア度・排出率・リストはスクリプト内 <code>RARITY</code> / <code>POOL</code> を編集してください。</p>
</footer>

<script>
/* ---------------- ガチャ設定 ---------------- */
// レア度設定（演出色、基準排出率）
const RARITY = {
  "R":   { rate: 0.75, flare: "rgba(86,204,242,.35)"  },
  "SR":  { rate: 0.20, flare: "rgba(161,140,209,.35)"},
  "SSR": { rate: 0.045,flare: "rgba(255,216,112,.40)"},
  "UR":  { rate: 0.005,flare: "rgba(0,227,174,.40)" }
};
// プール（名前/レア度/重み/アイコン）
const POOL = [
  { name:"スラッシュソード", rarity:"R",   weight: 10, icon:"🗡️" },
  { name:"ヒールポーション", rarity:"R",   weight: 10, icon:"🧪" },
  { name:"ライトボウ",       rarity:"R",   weight: 10, icon:"🏹" },
  { name:"魔術書の切れ端",   rarity:"R",   weight: 10, icon:"📜" },
  { name:"雷鳴の指輪",       rarity:"SR",  weight: 7,  icon:"💍" },
  { name:"紅蓮のローブ",     rarity:"SR",  weight: 7,  icon:"🧥" },
  { name:"蒼き宝珠",         rarity:"SR",  weight: 6,  icon:"🔮" },
  { name:"天空の大剣",       rarity:"SSR", weight: 3,  icon:"⚔️" },
  { name:"鳳凰の翼",         rarity:"SSR", weight: 2,  icon:"🪽" },
  { name:"世界樹の枝",       rarity:"UR",  weight: 1,  icon:"🌿" },
];

const GUARANTEE_MIN_RARITY = "SR"; // 10連の最低保証

/* -------------- 便利関数 -------------- */
const sum = arr => arr.reduce((a,c)=>a+c,0);
const pickWeighted = (entries, key="weight") => {
  const total = sum(entries.map(e=>e[key] ?? 1));
  let r = Math.random() * total;
  for(const e of entries){ r -= (e[key] ?? 1); if(r < 0) return e; }
  return entries[entries.length-1];
};
const now = () => new Date().toLocaleString("ja-JP");

/* -------------- 抽選ロジック -------------- */
function drawOne() {
  // 1) レア度を抽選（RARITY.rate）
  const rarityRoll = pickWeighted(Object.entries(RARITY).map(([k,v])=>({key:k, weight:v.rate})), "weight").key;
  // 2) そのレア度の中から重み付き抽選
  const candidates = POOL.filter(p=>p.rarity===rarityRoll);
  const item = pickWeighted(candidates);
  return item;
}

function drawTen() {
  const results = Array.from({length:10}, ()=> drawOne());
  // 最低保証（SR以上）
  const rankOrder = ["R","SR","SSR","UR"];
  const hasGuaranteed = results.some(r => rankOrder.indexOf(r.rarity) >= rankOrder.indexOf(GUARANTEE_MIN_RARITY));
  if(!hasGuaranteed){
    // 末尾1枠を保証枠で引き直し
    const cand = POOL.filter(p => rankOrder.indexOf(p.rarity) >= rankOrder.indexOf(GUARANTEE_MIN_RARITY));
    results[results.length-1] = pickWeighted(cand);
  }
  return results;
}

/* -------------- 画面描画 -------------- */
const grid = document.getElementById("grid");
const badge = document.getElementById("badge");
const headline = document.getElementById("headline");
const doors = document.getElementById("doors");
const flare = document.getElementById("flare");

function rarityToFlareColor(rarity){
  return RARITY[rarity]?.flare ?? "rgba(0,212,255,.25)";
}
function highestRarity(items){
  const pr = { "R":1,"SR":2,"SSR":3,"UR":4 };
  return items.reduce((m,x)=> pr[x.rarity] > pr[m.rarity] ? x : m, items[0]);
}

function showResults(items){
  // ステージ演出
  const top = highestRarity(items);
  flare.style.setProperty("--flare", rarityToFlareColor(top.rarity));
  flare.classList.add("show");
  setTimeout(()=>doors.classList.add("open"), 60);

  // 結果グリッド
  grid.innerHTML = "";
  for(const it of items){
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="icon">${it.icon}</div>
      <div class="name">${it.name}</div>
      <div class="rarity ${it.rarity}"></div>
    `;
    grid.appendChild(el);
  }
  badge.textContent = `${items.length} 回`;
  const counts = countByRarity(items);
  headline.textContent = `${now()}｜UR:${counts.UR} / SSR:${counts.SSR} / SR:${counts.SR} / R:${counts.R}`;
  // パーティクル（控えめ）
  burstParticles(top.rarity);
}

/* -------------- パーティクルちょい足し -------------- */
const cvs = document.getElementById("particles");
const ctx = cvs.getContext("2d");
let particles = [];
function resizeCanvas(){
  cvs.width = cvs.clientWidth; cvs.height = cvs.clientHeight;
}
addEventListener("resize", resizeCanvas); resizeCanvas();

function burstParticles(rarity){
  const N = rarity==="UR" ? 90 : rarity==="SSR" ? 70 : rarity==="SR" ? 45 : 25;
  for(let i=0;i<N;i++){
    particles.push({
      x: cvs.width/2, y: cvs.height/2,
      vx: (Math.random()*2-1)* (1.5 + Math.random()*2),
      vy: (Math.random()*2-1)* (1.5 + Math.random()*2),
      life: 40 + Math.random()*40,
      color: rarityToCss(rarity), size: 2 + Math.random()*2
    });
  }
}
function rarityToCss(r){
  switch(r){
    case "UR": return "#00e3ae";
    case "SSR": return "#ffbf3f";
    case "SR": return "#c8a7ff";
    default: return "#7fb9ff";
  }
}
function tick(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  for(const p of particles){
    p.x += p.vx; p.y += p.vy; p.vy += 0.02;
    p.life -= 1;
    ctx.globalAlpha = Math.max(p.life/80, 0);
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, p.size, p.size);
  }
  particles = particles.filter(p=>p.life>0 && p.x>-10 && p.x<cvs.width+10 && p.y>-10 && p.y<cvs.height+10);
  requestAnimationFrame(tick);
}
tick();

/* -------------- 数え上げ -------------- */
function countByRarity(items){
  const c = {R:0,SR:0,SSR:0,UR:0};
  for(const it of items) c[it.rarity] = (c[it.rarity]||0)+1;
  return c;
}

/* -------------- 画像保存 / Tweet -------------- */
document.getElementById("btnSave").addEventListener("click", async ()=>{
  const target = document.getElementById("card");
  const canvas = await html2canvas(target, { scale: 2, backgroundColor: "#0e1220" });
  const a = document.createElement("a");
  a.download = `gacha_result_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
  a.href = canvas.toDataURL("image/png");
  a.click();
});

document.getElementById("btnTweet").addEventListener("click", ()=>{
  const text = encodeURIComponent(headline.textContent + " #ガチャ #デモ");
  const url  = encodeURIComponent(location.href);
  const intent = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
  window.open(intent, "_blank");
});

/* -------------- ボタン挙動 -------------- */
document.getElementById("btnSingle").addEventListener("click", ()=>{
  resetStage();
  const result = [drawOne()];
  showResults(result);
});
document.getElementById("btnTen").addEventListener("click", ()=>{
  resetStage();
  const result = drawTen();
  showResults(result);
});
document.getElementById("btnReset").addEventListener("click", ()=>{
  resetStage(true);
  grid.innerHTML = "";
  badge.textContent = "0 回";
  headline.textContent = "結果がここに表示されます";
});

/* -------------- 演出リセット -------------- */
function resetStage(quick=false){
  doors.classList.remove("open");
  flare.classList.remove("show");
  if(quick){
    // すぐ閉じたいときの小細工（transition再適用）
    doors.style.transition="none";
    void doors.offsetWidth;
    doors.style.transition="";
  }
}
</script>
</body>
</html>
