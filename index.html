<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚ªãƒ¼ã‚¤ã‚·ã‚¬ãƒãƒ£ -SSAå˜ç‹¬è¨˜å¿µãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—-</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
  :root{
    --w: min(1120px, 96vw);
    --bg: radial-gradient(1200px 600px at 50% -100px, #151a27 0%, #0b0f1b 45%, #070915 100%);
    --panel: rgba(255,255,255,.06);
    --border: rgba(255,255,255,.10);
  }
  html,body{height:100%}
  body{
    margin:0; color:#fff;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
      "Hiragino Sans","Noto Sans JP","Yu Gothic UI", Roboto, sans-serif;
    background: var(--bg);
  }
  header, main, footer { width: var(--w); margin: 18px auto; }
  header h1{ margin: 8px 0 4px; font-size: clamp(22px,3.6vw,28px); letter-spacing:.02em; }
  header p { margin: 0; color:#b9c4d4; }

  .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
  .btn{
    padding:10px 14px; border:1px solid rgba(255,255,255,.25);
    background: var(--panel); color:#fff; border-radius:8px; cursor:pointer;
    backdrop-filter: blur(4px);
  }
  .btn.primary{ background: linear-gradient(135deg,#ff357a,#ff8a00); border-color: transparent; }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }

  /* ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆ1æšãšã¤ã®è¡¨ç¤ºï¼‰ */
  #stage{
    position:relative; height: 340px; border-radius:14px; overflow:hidden;
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    box-shadow: 0 12px 40px rgba(0,0,0,.35) inset, 0 8px 26px rgba(0,0,0,.24);
    display:grid; place-items:center;
  }
  #stage .hint{ position:absolute; bottom:10px; left:0; right:0; text-align:center; color:#c7d2e4; opacity:.8; font-size:12px; }
  #btnSkipAll{ position:absolute; top:10px; right:10px; z-index:5; display:none; font-size:12px; }

  /* æ—§URæ¼”å‡ºï¼ˆæœªä½¿ç”¨ã ãŒæ®‹ç½®ï¼‰ */
  .beam{ position:absolute; inset:-20% 35% -40% 35%; opacity:0; pointer-events:none; }
  .beam.show{ display:none !important; }
  .rays{ position:absolute; inset:-20% -20%; opacity:0; pointer-events:none; }
  .rays.show{ display:none !important; }

  /* ã‚«ãƒ¼ãƒ‰ï¼ˆ3Dã‚ãã‚Šï¼‰ */
  .card{ width:min(280px,70vw); height:min(180px,45vw); perspective: 1000px; }
  .card .inner{ position:relative; width:100%; height:100%; transform-style:preserve-3d; transition: transform 700ms cubic-bezier(.2,.8,.2,1); }
  .card.open .inner{ transform: rotateY(180deg); }
  .face{ position:absolute; inset:0; border-radius:16px; backface-visibility:hidden; overflow:hidden; border:1px solid var(--border); }
  .back{ display:grid; place-items:center; background: linear-gradient(135deg,#1a2030,#0e1422); }
  .back::after{ content:"â˜… TAP"; font-weight:700; letter-spacing:.08em; color:#9fb1ff; }
  .front{ transform: rotateY(180deg); background:#0b0f1b; display:grid; grid-template-rows:1fr auto; }
  .art{ display:grid; place-items:center; }
  .icon{ font-size:42px; }
  .name{ position:relative; text-align:center; font-size:12px; color:#d5dfef; padding:8px; border-top:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .name.marquee{ overflow:hidden; }
  .name .track{ display:inline-block; will-change: transform; }
  .name .scroll{ display:inline-block; padding-right:28px; }
  @keyframes scrollX{ from{ transform:translateX(0);} to{ transform:translateX(-50%);} }
  .name.marquee .track{ animation: scrollX 9s linear infinite; }
  .name.marquee:hover .track{ animation-play-state: paused; }
  @media (prefers-reduced-motion: reduce){
    .name.marquee .track{ animation:none; }
  }

  /* ãƒ¬ã‚¢åº¦ã‚°ãƒ­ãƒ¼ */
  .glow{ position:absolute; inset:-2px; border-radius:16px; pointer-events:none; mix-blend-mode:screen; opacity:.85; }
  .R  .glow{ background: radial-gradient(80% 60% at 50% -10%, rgba(86,204,242,.30), transparent 60%); }
  .SR .glow{ background: radial-gradient(80% 60% at 50% -10%, rgba(193,168,255,.38), transparent 60%); }
  .SSR .glow{ background: radial-gradient(80% 60% at 50% -10%, rgba(255,216,112,.45), transparent 60%); }
  .UR  .glow{ background: radial-gradient(80% 60% at 50% -10%, rgba(0,227,174,.65), transparent 60%); }
  .EX  .glow{ background: radial-gradient(80% 60% at 50% -10%, rgba(255,64,96,.55), transparent 60%); }
  .SSR.glowPulse, .UR.glowPulse, .EX.glowPulse { animation: glow 1.8s ease-in-out infinite; }
  @keyframes glow{ 0%,100%{opacity:.7} 50%{opacity:1} }

  /* ç‰¹æ®Šæ¼”å‡ºï¼ˆè¡¨ã«ã™ã‚‹å‰ï¼‰ï¼‹ãƒ•ãƒªãƒ¼ã‚ºæ¼”å‡º */
  .flash{ position:absolute; inset:0; background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.95), transparent 60%); opacity:0; pointer-events:none; }
  .flash.show{ animation: flash .22s ease forwards; }
  @keyframes flash{ from{opacity:0} to{opacity:1} }
  #shakeHost.shake{ animation:shake .6s cubic-bezier(.36,.07,.19,.97) both }
  @keyframes shake{10%,90%{transform:translate3d(-1px,0,0)}20%,80%{transform:translate3d(2px,0,0)}30%,50%,70%{transform:translate3d(-4px,0,0)}40%,60%{transform:translate3d(4px,0,0)}}

  .freezeOverlay{ position:fixed; inset:0; z-index:20; pointer-events:none; opacity:0; }
  .freezeWhite{ background:#fff; }
  .freezeScan{
    background: repeating-linear-gradient(to bottom, rgba(0,0,0,.0) 0px, rgba(0,0,0,.0) 2px, rgba(0,0,0,.06) 3px, rgba(0,0,0,.06) 4px);
    mix-blend-mode: multiply;
  }
  .freezeChromatic{
    background: radial-gradient(1200px 800px at 50% 40%, rgba(255,255,255,.0) 0%, rgba(255,255,255,.0) 55%, rgba(255,0,120,.18) 70%, rgba(0,220,255,.18) 82%, rgba(255,255,255,.0) 100%);
    mix-blend-mode: screen; filter: blur(2px);
  }
  @keyframes whiteHold { 0%{opacity:0} 12%{opacity:1} 70%{opacity:1} 100%{opacity:0} }
  @keyframes scanPulse { 0%{opacity:0} 15%{opacity:.8} 70%{opacity:.8} 100%{opacity:0} }
  @keyframes chromaPulse{ 0%{opacity:0} 20%{opacity:1} 70%{opacity:1} 100%{opacity:0} }
  @media (prefers-reduced-motion: reduce){ .freezeOverlay{ display:none; } }

  /* æœ€çµ‚çµæœã‚«ãƒ¼ãƒ‰ */
  #resultCard{ margin-top:16px; background: var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.26); }
  .summary{ display:flex; align-items:center; gap:10px; }
  .badge{ background:#e0133c; padding:4px 10px; border-radius:999px; font-weight:700; }
  .grid{ display:grid; grid-template-columns: repeat(5,1fr); gap:10px; margin-top:12px; }
  @media (max-width:640px){ .grid{ grid-template-columns: repeat(3,1fr); } }
  @media (max-width:400px){ .grid{ grid-template-columns: repeat(2,1fr); } }
  .item{ background:#0b0f1b; border:1px solid var(--border); border-radius:10px; padding:10px; text-align:center; position:relative; overflow:hidden; }
  .item .icon{ font-size:28px; }
  .item .rarityBar{ position:absolute; inset:auto 0 0 0; height:6px; }
  .R  .rarityBar{ background: linear-gradient(90deg,#56ccf2,#2f80ed); }
  .SR .rarityBar{ background: linear-gradient(90deg,#a18cd1,#fbc2eb); }
  .SSR .rarityBar{ background: linear-gradient(90deg,#ffd76f,#ff8a00); box-shadow:0 0 16px rgba(255,200,64,.6); }
  .UR .rarityBar{ background: linear-gradient(90deg,#9be15d,#00e3ae); box-shadow:0 0 18px rgba(0,227,174,.7); }
  .EX .rarityBar{ background: linear-gradient(90deg,#ff4d6d,#ff8a00); box-shadow:0 0 18px rgba(255,64,96,.65); }

  /* UR/EXã‚«ãƒ¼ãƒ‰ç”¨ï¼šå¸¸æ™‚ã‚­ãƒ©ç²’Canvas */
  .sparkle { position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen; opacity:.95; }

  /* æ å¤– */
  .postActions{ width:var(--w); margin:10px auto 0; }
  .postActions .toolbar{ margin-top:10px; }
  .note{ color:#9fb1c8; font-size:12px; margin:6px 0 0; }

  /* EXæ’å‡ºå›ã¯çµæœã‚«ãƒ¼ãƒ‰èµ¤ãƒ¢ãƒ¼ãƒ‰ */
  #resultCard.exMode{
    background: linear-gradient(180deg, rgba(255,80,112,.14), rgba(255,80,112,.06));
    border-color: rgba(255,120,140,.28);
    box-shadow: 0 12px 40px rgba(255,64,96,.22) inset, 0 8px 26px rgba(255,64,96,.28);
  }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ’å‡ºç¢ºç‡/ã‚¢ãƒ«ãƒãƒ ï¼‰ */
  .modal{ position:fixed; inset:0; display:none; place-items:center; background: rgba(0,0,0,.55); z-index:10; }
  .modal.show{ display:grid; }
  .sheet{
    width:min(900px, 94vw);
    max-height: 85vh;
    overflow:auto;
    background:#0f1424; border:1px solid var(--border);
    border-radius:12px; padding:14px;
    box-shadow: 0 20px 80px rgba(0,0,0,.6);
  }
  .sheet h2{ margin:4px 0 8px; font-size:18px; }
  .sheet .close{ float:right; font-weight:700; cursor:pointer; padding:6px 12px; border-radius:6px; background:#222b3f; }
  .rates{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px; }
  @media (max-width:640px){ .rates{ grid-template-columns: 1fr; } }
  .rates table{ width:100%; border-collapse:collapse; background:#0b0f1b; border:1px solid var(--border); border-radius:8px; overflow:hidden; }
  .rates th, .rates td{ padding:8px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left; }
  .rates th{ background:#131a2b; position: sticky; top: 0; z-index: 1; }
</style>
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body id="shakeHost">
<header>
  <h1>ã‚ªãƒ¼ã‚¤ã‚·ã‚¬ãƒãƒ£ -SSAå˜ç‹¬è¨˜å¿µãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—-</h1>
  <p>ç¥ãƒ»SSAå˜ç‹¬2DAYSé–‹å‚¬ï¼ã‚­ãƒŸã‚‚ã‚ªãƒ¼ã‚¤ã‚·ã«ãªã‚‰ãªã„ã‹ï¼Ÿ</p>
  <div class="toolbar">
    <button class="btn" id="btnSingle">å˜ç™ºï¼ˆ1å›ï¼‰</button>
    <button class="btn primary" id="btnTen">10é€£</button>
    <button class="btn" id="btnAlbum">ã‚¢ãƒ«ãƒãƒ </button>
    <button class="btn" id="btnReset">ã‚¯ãƒªã‚¢</button>
    <button class="btn" id="btnRates">æ’å‡ºç¢ºç‡</button>
  </div>
</header>

<main style="width:var(--w); margin:auto;">
  <div id="stage" aria-label="æ¼”å‡ºã‚¹ãƒ†ãƒ¼ã‚¸">
    <div class="beam" id="beam"></div>
    <div class="rays" id="rays"></div>
    <canvas id="spark" style="position:absolute;inset:0;pointer-events:none"></canvas>

    <!-- ãƒ•ãƒªãƒ¼ã‚ºæ¼”å‡º -->
    <div class="freezeOverlay freezeWhite" id="freezeWhite"></div>
    <div class="freezeOverlay freezeScan"  id="freezeScan"></div>
    <div class="freezeOverlay freezeChromatic" id="freezeChroma"></div>

    <div id="stageHost"></div>
    <button id="btnSkipAll" class="btn">ã™ã¹ã¦ã‚ãã‚‹</button>
    <div class="flash" id="flash"></div>
    <div class="hint" id="hint"></div>
  </div>

  <!-- æœ€çµ‚çµæœ -->
  <section id="resultCard" tabindex="-1">
    <div class="summary">
      <span class="badge" id="badge">0 å›</span>
      <div id="headline">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
    <div class="grid" id="grid"></div>
  </section>

  <!-- æ å¤–ã®ãƒœã‚¿ãƒ³ç¾¤ -->
  <div class="postActions">
    <div class="toolbar">
      <button class="btn" id="btnSave">çµæœã‚’ç”»åƒä¿å­˜</button>
      <button class="btn" id="btnTweet">Tweetï¼ˆçµæœã‚’å…±æœ‰ï¼‰</button>
    </div>
    <p class="note">â€»ç”»åƒã¯è‡ªå‹•æ·»ä»˜ã§ããªã„ãŸã‚ã€ä¿å­˜å¾Œã«ãƒ„ã‚¤ãƒ¼ãƒˆç”»é¢ã§æ·»ä»˜ã—ã¦ãã ã•ã„ã€‚</p>
    <p class="note">â€»æœ¬ã‚¬ãƒãƒ£ã¯å€‹äººã®è¶£å‘³åˆ¶ä½œã§ã‚ã‚Šã€å…¬å¼ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  </div>
</main>

<!-- æ’å‡ºç¢ºç‡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="modal">
  <div class="sheet" id="ratesSheet">
    <span class="close" id="closeModal">Ã—</span>
    <h2>æ’å‡ºç¢ºç‡ / ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—</h2>
    <div class="rates">
      <table>
        <thead><tr><th>ãƒ¬ã‚¢åº¦</th><th>æä¾›å‰²åˆ</th></tr></thead>
        <tbody id="rateBody"></tbody>
      </table>
      <table>
        <thead><tr><th>ãƒ¬ã‚¢åº¦</th><th>åç§°</th></tr></thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ã‚¢ãƒ«ãƒãƒ ï¼ˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ -->
<div class="modal" id="albumModal">
  <div class="sheet" id="albumSheet">
    <span class="close" id="closeAlbum">Ã—</span>
    <h2>ã‚¢ãƒ«ãƒãƒ  / ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>
    <div id="albumStats" style="margin:6px 0 10px;color:#b9c4d4;"></div>
    <div class="toolbar" style="margin:8px 0 10px;">
      <select id="albumFilter">
        <option value="ALL">ã™ã¹ã¦</option>
        <option value="EX">EX</option>
        <option value="UR">UR</option>
        <option value="SSR">SSR</option>
        <option value="SR">SR</option>
        <option value="R">R</option>
      </select>
      <button class="btn" id="btnAlbumShot">ã‚¢ãƒ«ãƒãƒ ã‚’ç”»åƒä¿å­˜</button>
      <button class="btn" id="btnResetAlbum">é€²æ—ãƒªã‚»ãƒƒãƒˆï¼ˆç«¯æœ«å†…ï¼‰</button>
    </div>
    <div class="grid" id="albumGrid"></div>
  </div>
</div>

<script>
/* ---- ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ï¼†ç¢ºç‡ï¼ˆEXè¿½åŠ ãƒ»URèª¿æ•´ï¼‰ ---- */
const RARITY = {
  "R":   { rate: 0.52,  color:"#56ccf2", name:"R" },
  "SR":  { rate: 0.35,  color:"#c1a8ff", name:"SR" },
  "SSR": { rate: 0.10,  color:"#ffd870", name:"SSR" },
  "UR":  { rate: 0.025, color:"#00e3ae", name:"UR" },   // 2.5%
  "EX":  { rate: 0.005, color:"#ff4060", name:"EX" }    // 0.5%
}; // åˆè¨ˆ = 1.0

const POOL = [
  { name:"ãƒ¡ã‚¬ãƒ", rarity:"R",   icon:"ğŸ‘“" },
  { name:"ãƒãƒŠãƒŠ", rarity:"R",   icon:"ğŸŒ" },
  { name:"ãƒã‚¤ã‚¯", rarity:"R",   icon:"ğŸ¤" },
  { name:"ã‚®ã‚¿ãƒ¼", rarity:"R",   icon:"ğŸ¸" },
  { name:"ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹", rarity:"R", icon:"ğŸ›" },

  { name:"ã‚ª", rarity:"SR", icon:"ğŸŸ¥" },
  { name:"ãƒ¼", rarity:"SR", icon:"ğŸŸ¥" },
  { name:"ã‚¤", rarity:"SR", icon:"ğŸŸ¥" },
  { name:"ã‚·", rarity:"SR", icon:"ğŸŸ¥" },
  { name:"ãƒ", rarity:"SR", icon:"ğŸŸ¥" },
  { name:"ã‚µ", rarity:"SR", icon:"ğŸŸ¥" },
  { name:"ãƒ¨", rarity:"SR", icon:"ğŸŸ¥" },

  { name:"ã‚ªãƒ¼ãƒã‚¤ã‚´ã‚·ã‚´ã‚·", rarity:"SSR", icon:"âœ¨" },
  { name:"ã‚ªãƒ¼ã‚¤ã‚·ãƒŠã‚«ãƒ¨ã‚·", rarity:"SSR", icon:"âœ¨" },
  { name:"OxT", rarity:"SSR", icon:"ğŸµ" },
  { name:"Sound Schedule", rarity:"SSR", icon:"ğŸ¶" },
  { name:"å¤§çŸ³æ˜Œè‰¯", rarity:"SSR", icon:"ğŸŒŸ" },

  { name:"ã‚ªãƒ¼ã‚¤ã‚·ãƒã‚µãƒ¨ã‚·", rarity:"UR", icon:"ğŸ§‘â€ğŸ¤" },

  /* â˜… EXï¼ˆ0.5%ï¼‰ */
  { name:"ç¾©å‹™ã‚ã‚‰ã®ãƒã‚µãƒ¨ã‚·", rarity:"EX", icon:"ğŸ‘‘" },
];

/* ---- æ±ç”¨ ---- */
const sum = a => a.reduce((x,y)=>x+y,0);
const pickWeighted = (arr, key="weight")=>{
  const total = sum(arr.map(e=>e[key]??1)); let r=Math.random()*total;
  for(const e of arr){ r -= (e[key]??1); if(r<0) return e; }
  return arr.at(-1);
};
const now = ()=> new Date().toLocaleString("ja-JP");
const rankOrder = ["R","SR","SSR","UR","EX"];
const rankIdx = r => rankOrder.indexOf(r);

/* ---- æŠ½é¸ ---- */
function drawOne(){
  const rEntry = pickWeighted(Object.entries(RARITY).map(([k,v])=>({key:k, weight:v.rate})), "weight");
  const rarity = rEntry.key;
  const bucket = POOL.filter(p=>p.rarity===rarity);
  return bucket[Math.floor(Math.random()*bucket.length)];
}
function drawN(n){ return Array.from({length:n}, drawOne); }

/* ---- ã‚¹ãƒ†ãƒ¼ã‚¸ ---- */
const stage = document.getElementById("stage");
const stageHost = document.getElementById("stageHost");
const hint = document.getElementById("hint");
const flash = document.getElementById("flash");
const shakeHost = document.getElementById("shakeHost");
const btnSkipAll = document.getElementById("btnSkipAll");
const spark = document.getElementById("spark");
const spctx = spark.getContext("2d");
function resizeSpark(){ spark.width = spark.clientWidth; spark.height = spark.clientHeight; }
addEventListener("resize", resizeSpark); resizeSpark();

/* ãƒ•ãƒªãƒ¼ã‚ºæ¼”å‡ºãƒ¬ã‚¤ãƒ¤å‚ç…§ */
const freezeWhite = document.getElementById("freezeWhite");
const freezeScan  = document.getElementById("freezeScan");
const freezeChroma= document.getElementById("freezeChroma");

let queue = [], pointer = 0, phase = "idle", lockTap = false, inProgress = false;
let currentItem = null, currentCard = null, lastResults = [];

/* ---- çµæœã‚¨ãƒªã‚¢ã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ ---- */
function focusResult(){
  const rc = document.getElementById("resultCard");
  rc.scrollIntoView({behavior:"smooth", block:"start"});
  setTimeout(()=> rc.focus({preventScroll:true}), 300);
}

/* ---- ã‚«ãƒ¼ãƒ‰ ---- */
function createCard(item){
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <div class="inner">
      <div class="face back"></div>
      <div class="face front ${item.rarity}">
        <div class="glow"></div>
        <div class="art"><div class="icon">${item.icon||"ğŸ´"}</div></div>
        <div class="name">[${item.rarity}] ${item.name}</div>
      </div>
    </div>`;
  return card;
}

/* ---- æ¼”å‡º ---- */
function flashShake(stronger=false){
  flash.classList.add("show");
  shakeHost.style.transformOrigin = "50% 40%";
  shakeHost.classList.add("shake");
  shakeHost.style.animationDuration = stronger ? ".8s" : ".6s";
  setTimeout(()=>flash.classList.remove("show"), 220);
  setTimeout(()=>{
    shakeHost.classList.remove("shake");
    shakeHost.style.animationDuration = "";
  }, stronger ? 820 : 620);
}
function confettiBurst(){
  const N = 260;
  const cx = spark.width/2, cy = spark.height*0.46;
  const parts = [];
  for(let i=0;i<N;i++){
    parts.push({
      x: cx, y: cy,
      vx: (Math.random()*2-1) * (5+Math.random()*6),
      vy: (Math.random()*2-1) * (5+Math.random()*6) - 2.5,
      life: 60 + Math.random()*60,
      size: 1.5 + Math.random()*3,
      color: ["#00e3ae","#ffd870","#00d4ff","#ff4d6d","#ffffff"][i%5]
    });
  }
  let alive = true;
  (function tick(){
    if(!alive) return;
    spctx.clearRect(0,0,spark.width,spark.height);
    for(const p of parts){
      p.x+=p.vx; p.y+=p.vy; p.vy+=0.035; p.life-=1;
      spctx.globalAlpha = Math.max(p.life/90,0);
      spctx.fillStyle = p.color;
      spctx.fillRect(p.x, p.y, p.size, p.size);
    }
    if(parts.every(p=>p.life<=0)){ alive=false; spctx.clearRect(0,0,spark.width,spark.height); return; }
    requestAnimationFrame(tick);
  })();
}
function freezeBurstFX(){
  freezeWhite.style.animation = "whiteHold 1.2s ease forwards";
  freezeScan.style.animation  = "scanPulse 1.2s ease forwards";
  freezeChroma.style.animation= "chromaPulse 1.2s ease forwards";
  flashShake(true);
  confettiBurst();
  setTimeout(()=>{ freezeWhite.style.animation = ""; freezeScan.style.animation  = ""; freezeChroma.style.animation= ""; }, 1250);
  return 900;
}
function playSpecialBeforeReveal(rarity){
  if(rarity==="UR" || rarity==="EX"){ return freezeBurstFX(); }
  if(rarity==="SSR"){ flashShake(); return 220; }
  return 0;
}

/* ---- é€²è¡Œåˆ¶å¾¡ ---- */
function clearResultsView(){
  stopAllItemSparkles();
  grid.innerHTML = ""; badge.textContent = "0 å›"; headline.textContent = "çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™";
  document.getElementById("resultCard").classList.remove("exMode");
}
function showNextCard(){
  if(pointer >= queue.length){
    inProgress = false; phase = "idle";
    lastResults = queue.slice();
    showAllResults(queue);
    hint.textContent = ""; btnSkipAll.style.display = "none";
    focusResult();
    return;
  }
  stageHost.innerHTML = "";
  currentItem = queue[pointer];
  currentCard = createCard(currentItem);
  stageHost.appendChild(currentCard);
  hint.textContent = "ã‚¿ãƒƒãƒ—ã§ã‚ãã‚‹";
  phase = "closed";
  btnSkipAll.style.display = (queue.length>1) ? "inline-block" : "none";
}
stage.addEventListener("click", ()=>{
  if(!inProgress || !currentCard) return;
  if(lockTap) return;
  if(phase === "closed"){
    lockTap = true;
    const delay = playSpecialBeforeReveal(currentItem.rarity);
    setTimeout(()=>{
      currentCard.classList.add("open");
      if(currentItem.rarity==="SSR" || currentItem.rarity==="UR" || currentItem.rarity==="EX"){
        currentCard.querySelector(".front").classList.add("glowPulse");
      }
      phase = "opened";
      if(queue.length === 1){
        setTimeout(()=>{ pointer = 1; showNextCard(); }, 450);
      }else{
        hint.textContent = (pointer < queue.length-1) ? "ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã§æ¬¡ã¸" : "ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã§çµæœä¸€è¦§ã¸";
      }
      lockTap = false;
    }, delay);
  } else if(phase === "opened"){
    pointer++; showNextCard();
  }
});
btnSkipAll.addEventListener("click", (e)=>{
  e.stopPropagation();
  if(!inProgress) return;
  stageHost.innerHTML = "";
  currentCard = null;
  hint.textContent = "";
  const hasEX  = queue.some(x=>x.rarity==="EX");
  const hasUR  = !hasEX && queue.some(x=>x.rarity==="UR");
  const hasSSR = !hasEX && !hasUR && queue.some(x=>x.rarity==="SSR");
  let d = 0;
  if(hasEX || hasUR){ d = freezeBurstFX(); }
  else if(hasSSR){ flashShake(); d = 260; }
  setTimeout(()=>{
    inProgress = false; phase = "idle"; lastResults = queue.slice();
    showAllResults(queue); btnSkipAll.style.display = "none"; focusResult();
  }, d);
});

/* ---- å®Ÿè¡Œãƒœã‚¿ãƒ³ ---- */
function runTen(){ if(inProgress) return; clearResultsView(); queue = drawN(10); pointer = 0; inProgress = true; showNextCard(); }
function runSingle(){ if(inProgress) return; clearResultsView(); queue = drawN(1); pointer = 0; inProgress = true; showNextCard(); }

/* ---- æœ€çµ‚çµæœã‚«ãƒ¼ãƒ‰ ---- */
const grid = document.getElementById("grid");
const badge = document.getElementById("badge");
const headline = document.getElementById("headline");

/* ã‚­ãƒ©ç²’ç®¡ç† */
const activeSparkles = [];
function stopAllItemSparkles(){
  while(activeSparkles.length){
    const stop = activeSparkles.pop();
    try{ stop && stop(); }catch(e){}
  }
}
function startItemSparkles(canvas){
  const ctx = canvas.getContext("2d");
  let running = true;
  const ro = new ResizeObserver(()=>{ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; });
  ro.observe(canvas);
  canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
  const PALETTE = ["#00e3ae","#ffd870","#00d4ff","#ffffff","#ff4d6d"];
  const MAX = 90;
  const parts = [];
  function spawn(k=3){
    for(let i=0;i<k;i++){
      parts.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: (Math.random()-0.5)*0.25, vy: -0.15 - Math.random()*0.35, life: 60 + Math.random()*60, size: 0.8 + Math.random()*1.8, color: PALETTE[Math.floor(Math.random()*PALETTE.length)] });
    }
  }
  function tick(){
    if(!running) return;
    if(parts.length < MAX) spawn(2 + Math.floor(Math.random()*3));
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let i=parts.length-1;i>=0;i--){
      const p = parts[i];
      p.x+=p.vx; p.y+=p.vy; p.life--;
      if(p.x<0) p.x+=canvas.width; if(p.x>canvas.width) p.x-=canvas.width;
      if(p.y<0) p.y+=canvas.height;
      if(p.life<=0){ parts.splice(i,1); continue; }
      ctx.globalAlpha = Math.max(p.life/90,0.9)*0.9;
      ctx.fillStyle = p.color;
      ctx.fillRect(p.x, p.y, p.size, p.size);
    }
    requestAnimationFrame(tick);
  }
  tick();
  return function stop(){ running=false; ro.disconnect(); ctx.clearRect(0,0,canvas.width,canvas.height); };
}

/* åå‰é•·ã„ã¨ãã«ãƒãƒ«ã‚­ãƒ¼ */
function applyMarqueeIfOverflow(el){
  const nameEl = el.querySelector('.name');
  if(!nameEl || nameEl.classList.contains('marquee')) return;
  const raw = nameEl.textContent;
  nameEl.style.whiteSpace = 'nowrap'; nameEl.style.overflow = 'hidden'; nameEl.style.textOverflow = 'clip';
  const need = nameEl.scrollWidth > nameEl.clientWidth + 2;
  if(!need) return;
  nameEl.classList.add('marquee');
  nameEl.innerHTML = `<span class="track" aria-hidden="true"><span class="scroll">${raw}</span><span class="scroll"> ${raw}</span></span>`;
}

function highestItem(items){ return items.reduce((m,x)=> rankIdx(x.rarity) > rankIdx(m.rarity) ? x : m, items[0]); }
function countByRarity(items){ const c={R:0,SR:0,SSR:0,UR:0,EX:0}; for(const it of items) c[it.rarity]++; return c; }

function showAllResults(items){
  stopAllItemSparkles();
  grid.innerHTML = "";
  for(const it of items){
    const el = document.createElement("div");
    el.className = `item ${it.rarity}`;
    el.innerHTML = `<div class="icon">${it.icon||"ğŸ´"}</div><div class="name">[${it.rarity}] ${it.name}</div><div class="rarityBar"></div>`;
    grid.appendChild(el);
    applyMarqueeIfOverflow(el);
    if(it.rarity === "UR" || it.rarity === "EX"){
      const cv = document.createElement("canvas");
      cv.className = "sparkle";
      el.appendChild(cv);
      requestAnimationFrame(()=>{ const stop = startItemSparkles(cv); activeSparkles.push(stop); });
    }
  }
  badge.textContent = `${items.length} å›`;
  const top = highestItem(items);
  const counts = countByRarity(items);
  const rc = document.getElementById("resultCard");
  if(counts.EX > 0) rc.classList.add("exMode"); else rc.classList.remove("exMode");
  headline.textContent = `${now()}ï½œæœ€é«˜:${top.rarity}ã€Œ${top.name}ã€ï½œEX:${counts.EX} / UR:${counts.UR} / SSR:${counts.SSR} / SR:${counts.SR} / R:${counts.R}`;

  /* â–¼ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆã‚¢ãƒ«ãƒãƒ ç”¨ï¼‰ */
  recordResults(items);
}

/* ---- çµæœä¿å­˜/Tweet/ã‚¢ãƒ«ãƒãƒ ã‚¹ã‚¯ã‚·ãƒ§ ---- */
document.getElementById("btnSave").addEventListener("click", async ()=>{
  const target = document.getElementById("resultCard");
  const canvas = await html2canvas(target,{scale:2,backgroundColor:"#0b0f1b"});
  const a = document.createElement("a");
  a.download = `oishi_gacha_result_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
  a.href = canvas.toDataURL("image/png"); a.click();
});
document.getElementById("btnTweet").addEventListener("click", ()=>{
  const items = lastResults.length ? lastResults : queue;
  if(!items.length){ alert("å…ˆã«ã‚¬ãƒãƒ£ã‚’å¼•ã„ã¦ãã ã•ã„ã€‚"); return; }
  const top = highestItem(items);
  const text = [
    `${top.rarity}ã€Œ${top.name}ã€ã‚’å¼•ã„ãŸã‚ˆï¼`,
    `ã‚ãªãŸã‚‚ã‚ªãƒ¼ã‚¤ã‚·ã‚¬ãƒãƒ£ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã¦ï¼ï¼`,
    `#ã‚ªãƒ¼ã‚¤ã‚·ãƒã‚µãƒ¨ã‚· #ã‚ªãƒ¼ã‚¤ã‚·SSA #ã‚ªãƒ¼ã‚¤ã‚·ã‚¬ãƒãƒ£`,
    location.href
  ].join("\n");
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`,"_blank");
});

/* ---- ä¸Šéƒ¨ãƒœã‚¿ãƒ³ ---- */
document.getElementById("btnTen").addEventListener("click", runTen);
document.getElementById("btnSingle").addEventListener("click", runSingle);
document.getElementById("btnReset").addEventListener("click", ()=>{
  inProgress = false; queue = []; pointer = 0; phase = "idle"; lockTap = false;
  stageHost.innerHTML = ""; hint.textContent = "";
  clearResultsView(); btnSkipAll.style.display = "none";
});
document.getElementById("btnAlbum").addEventListener("click", ()=>{
  renderAlbum(document.getElementById("albumFilter").value);
  albumModal.classList.add("show");
});

/* ---- æ’å‡ºç¢ºç‡ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆEXã¯ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿè¡¨ç¤ºï¼‰ ---- */
const modal = document.getElementById("modal");
document.getElementById("btnRates").addEventListener("click", ()=>{
  const rb = document.getElementById("rateBody"); rb.innerHTML = "";
  for(const k of rankOrder){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="color:${RARITY[k].color};font-weight:700">${k}</td><td>${(RARITY[k].rate*100).toFixed(1)}%</td>`;
    rb.appendChild(tr);
  }
  const lb = document.getElementById("listBody"); lb.innerHTML = "";
  for(const it of POOL){
    const displayName = (it.rarity === "EX") ? "ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ" : it.name;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="color:${RARITY[it.rarity].color}">${it.rarity}</td><td>${displayName}</td>`;
    lb.appendChild(tr);
  }
  modal.classList.add("show");
});
document.getElementById("closeModal").addEventListener("click", ()=> modal.classList.remove("show"));
modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.classList.remove("show"); });

/* ======== ã“ã“ã‹ã‚‰ï¼šã‚¢ãƒ«ãƒãƒ ä¿å­˜ï¼†UI ======== */
const STORE_KEY = "oishi_gacha_progress_v1";
function defaultState(){ return { pulls:0, sessions:0, firstPlayedAt:null, lastPlayedAt:null, items:{} }; }
function loadState(){
  try{ const raw = localStorage.getItem(STORE_KEY); if(!raw) return defaultState();
       const st = JSON.parse(raw); return Object.assign(defaultState(), st, {items:Object.assign({}, st.items||{})}); }
  catch(e){ return defaultState(); }
}
function saveState(st){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(st)); }catch(e){} }
function recordResults(items){
  const st = loadState();
  const nowIso = new Date().toISOString();
  if(!st.firstPlayedAt) st.firstPlayedAt = nowIso;
  st.lastPlayedAt = nowIso;
  st.sessions += 1;
  st.pulls += items.length;
  for(const it of items){
    const key = it.name;
    if(!st.items[key]) st.items[key] = { name: it.name, rarity: it.rarity, count:0, firstAt:null, lastAt:null };
    st.items[key].count += 1;
    if(!st.items[key].firstAt) st.items[key].firstAt = nowIso;
    st.items[key].lastAt = nowIso;
  }
  saveState(st);
}
function collectionStats(){
  const st = loadState();
  const totalByR = {R:0,SR:0,SSR:0,UR:0,EX:0};
  const haveByR  = {R:0,SR:0,SSR:0,UR:0,EX:0};
  for(const p of POOL){
    totalByR[p.rarity]++;
    if(st.items[p.name]?.count>0){ haveByR[p.rarity]++; }
  }
  const totalKinds = POOL.length;
  const haveKinds  = Object.values(haveByR).reduce((a,b)=>a+b,0);
  const rate = (haveKinds/totalKinds*100).toFixed(1);
  return { st, totalByR, haveByR, totalKinds, haveKinds, rate };
}
function renderAlbum(filter="ALL"){
  const { st, totalKinds, haveKinds, rate } = collectionStats();
  const statsEl = document.getElementById("albumStats");
  statsEl.textContent = `ç·ã‚«ãƒ¼ãƒ‰ç¨® ${haveKinds}/${totalKinds}ï¼ˆ${rate}%ï¼‰ï½œç·æšæ•° ${st.pulls}ï½œãƒ—ãƒ¬ã‚¤å›æ•° ${st.sessions}`;

  const grid = document.getElementById("albumGrid");
  grid.innerHTML = "";
  const list = POOL.filter(p => filter==="ALL" ? true : p.rarity===filter);

  for(const p of list){
    const owned = !!st.items[p.name]?.count;
    const ct = st.items[p.name]?.count || 0;
    const title = (p.rarity==="EX" && !owned) ? "ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ" : p.name; // æœªæ‰€æŒEXã¯ä¼ã›ã‚‹
    const el = document.createElement("div");
    el.className = `item ${p.rarity}`;
    el.style.opacity = owned ? 1 : 0.55;
    el.innerHTML = `
      <div class="icon">${p.icon || "ğŸ´"}</div>
      <div class="name">[${p.rarity}] ${title}</div>
      <div class="rarityBar"></div>
      <div style="font-size:11px;color:#9fb1c8;margin-top:6px;">${owned ? `æ‰€æŒæšæ•°ï¼š${ct}` : `æœªæ‰€æŒ`}</div>
    `;
    grid.appendChild(el);
  }
}
/* ã‚¢ãƒ«ãƒãƒ UIã¨ã‚¹ã‚¯ã‚·ãƒ§ */
const albumModal = document.getElementById("albumModal");
document.getElementById("closeAlbum").addEventListener("click", ()=> albumModal.classList.remove("show"));
albumModal.addEventListener("click", (e)=>{ if(e.target===albumModal) albumModal.classList.remove("show"); });
document.getElementById("albumFilter").addEventListener("change", (e)=>{ renderAlbum(e.target.value); });
document.getElementById("btnResetAlbum").addEventListener("click", ()=>{
  if(confirm("ç«¯æœ«å†…ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
    localStorage.removeItem(STORE_KEY);
    renderAlbum(document.getElementById("albumFilter").value);
  }
});
document.getElementById("btnAlbumShot").addEventListener("click", async ()=>{
  const target = document.getElementById("albumSheet"); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ã‚’æ’®ã‚‹
  const canvas = await html2canvas(target,{scale:2,backgroundColor:"#0f1424"});
  const a = document.createElement("a");
  a.download = `oishi_album_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
  a.href = canvas.toDataURL("image/png"); a.click();
});
</script>
</body>
</html>
